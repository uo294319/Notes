
---
# Internet Protocol Security (IPsec)

[Back to index](../README.md)

---
![](../assets/Pasted%20image%2020251127094840.png)
## Introducción a IPsec
- **Def**. Conjunto de protocolos para autenticación y/o cifrado de paquetes IP
- Usa los protocolos:
	- **Encapsulating Security Payload - ESP** (obligatorio)
		- Confidencialidad y opcionalmente integridad y autenticación
	- **Authentication Header - AH**
		- Integridad, Autenticación y no repudio
- Ambos protocolos tienen dos modos:
	- **Transporte**.
		- Cifra solo los datos y conserva los header originales.
		- Permite enrutamiento con los headers.
		- Usado para conexiones extremo a extremo
	- **Túnel**.
		- Cifra todo el paquete y lo encapsula en otro paquete IP.
		- Usado como puente seguro entre equipos intermedios (firewalls o routers)
---
## Security Association Database (SAD)
- **Def**. Contiene una lista de asociaciones de seguridad (SA)
- Cada SA corresponde a una conexión lógica unidireccional mediante IPsec.
- Contiene
	- Índice como `uint_32` llamado Security Parameter Index (SPI)
	- IP destino
	- Security Protocol Identifier (AH o ESP)
---
## Security Policies Database (SPD)
- **Def**. Determina que paquetes deben ser procesados por IPsec y los asocia con una SA.
- Contiene:
	- Protocolo de la capa siguiente.
	- IPs y puertos de origen y de destino (pueden ser listas, rangos o wildcard `*`)
	- Acción
		- `DISCARD`. Descarta el paquete evitando que se procese.
		- `BYPASS`. Usa IP sin funciones de seguirdad.
		- `PROTECT: <protocolo> <modo>`. Protege el paquete con IPsec.
			- Protocolo puede ser ESP o AH y modo transporte o túnel.
---
## Funcionamiento
![](../assets/Pasted%20image%2020251127150910.png)
![](../assets/Pasted%20image%2020251127150809.png)

---
## Encapsulating Security Payload (ESP)
- Composición de paquete IPsec:
	- Nuevo IP header. Solo presente en modo túnel.
	- `ESP header`. No encriptado. Autentica hasta el trailer.
	- `IP header` (original). Si túnel se encripta. En transporte va delante del header.
	- `TCP header` y `TCP data` encriptados
	- `ESP trailer`.  Último tramo autenticado y encriptado.
	- `ESP auth`
---
## Authentication Header
- Añade un `AH header` con un Integrity Check Value al paquete IP
- Autentica lo que esté detrás:
	- Si transporte: `IP header` -> `AH header` -> (`TCP header` -> `TCP data`)
	- Si túner: `new IP header` -> `AH header` -> (`IP header` -> `TCP header` -> `TCP data`)
---
## Internet Key Exchange (IKE)
- Def. Permite un estado compartido entre producer y consumer de datagramas
	- Incluye Servicios, algoritmos criptográficos y claves de cifrado.
- Se basa en pares petición y respuesta llamados Exchanges